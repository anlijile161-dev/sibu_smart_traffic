<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,maximum-scale=1"
  />
  <title>Sibu Smart Traffic Beta+</title>
  <meta name="theme-color" content="#0b132b" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    :root {
      --bg: #0b132b;
      --panel: #16213e;
      --panel-2: #1f2a48;
      --text: #e6e6f0;
      --muted: #9aa0b4;
      --brand: #1abc9c;
      --danger: #ff7675;
      --ok: #2ecc71;
      --chip: #26314f;
      --btn: #233055;
      --btn-hover: #2b3b66;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei", sans-serif;
      background: var(--bg); color: var(--text);
    }
    header {
      position: sticky; top: 0; z-index: 20;
      background: rgba(11,19,43,.9); backdrop-filter: blur(6px);
      border-bottom: 1px solid #142044;
      padding: 10px 16px;
      display: flex; align-items: center; gap: 12px;
    }
    header .title { font-weight: 700; letter-spacing:.2px; }
    header .badge { font-size: 12px; padding:2px 8px; background:#143057; border-radius:999px; color:#8bd3ff; }
    header .spacer { flex:1; }
    header .user { display:flex; align-items:center; gap:10px; font-size: 14px; color:#cbd3ea;}
    header .btn { background: var(--btn); border:1px solid #30406f; color:#e9eefc; border-radius:10px; padding:8px 12px; cursor:pointer; }
    header .btn:hover { background: var(--btn-hover); }

    main { max-width: 1200px; margin: 16px auto; padding: 0 16px; display: grid; grid-template-columns: 1.15fr .85fr; gap:16px;}
    @media (max-width: 980px){ main{ grid-template-columns:1fr; } }

    .card { background: var(--panel); border:1px solid #1a274c; border-radius:14px; }
    .card .head { padding: 14px 16px; border-bottom:1px solid #1a274c; display:flex; align-items:center; gap:10px; }
    .card .head h3 { margin:0; font-size:16px; }
    .card .body { padding: 12px 16px; }

    #map { width: 100%; height: 360px; border-radius: 10px; overflow: hidden; border:1px solid #22345f; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .input, textarea, select { width:100%; color:#eaf1ff; background:#152347; border:1px solid #23345f; border-radius:10px; padding:10px 12px; }
    .muted { color: var(--muted); font-size: 12px; }
    .btn { background: var(--btn); border:1px solid #2a3b69; color:#eaf1ff; border-radius:10px; padding:10px 12px; cursor:pointer; }
    .btn:hover { background: var(--btn-hover); }
    .btn-primary { background:#2157a6; border-color:#2b6cd2; }
    .btn-primary:hover { background:#2b6cd2; }
    .btn-ghost { background: transparent; border-color:#2a3b69; }
    .chip { background: var(--chip); border:1px solid #2a3b69; color:#c9d6ff; padding:6px 8px; border-radius:999px; font-size:12px; }

    .list { display:flex; flex-direction:column; gap:10px; }
    .item { background: var(--panel-2); border:1px solid #263a70; border-radius:12px; padding:10px 12px; }
    .item .row1 { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .item .title { font-weight: 600; }
    .status-badge { font-size: 11px; padding:4px 8px; border-radius:999px; }
    .status-pending { background:#3b2a09; color:#ffd479; border:1px solid #5d420b; }
    .status-progress { background:#122e3a; color:#8ee0ff; border:1px solid #1f4d63; }
    .status-resolved { background:#10361f; color:#86ffb4; border:1px solid #1c5b35; }

    .toolbar { display:flex; gap:8px; flex-wrap:wrap; }
    .right { text-align:right; }
  </style>

  <!-- Leaflet JS (必须先于 heatmap 插件加载) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- Leaflet Heatmap 插件 -->
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

  <!-- Firebase v10 (Modular) -->
  <script type="module">
    /***** 1) Firebase Config  *****/
    // TODO: paste your existing firebaseConfig here (保持你的 apiKey/projectId 等原样)
    const firebaseConfig = {
    apiKey: "AIzaSyCHLxlEzLGC1gN1v0ryQe29acqb6IjM-YQ",
    authDomain: "sibu-smart-traffic.firebaseapp.com",
    projectId: "sibu-smart-traffic",
    storageBucket: "sibu-smart-traffic.appspot.com",
    messagingSenderId: "426450565021",
    appId: "1:426450565021:web:6dc1dc2542d0046c11a174",
    measurementId: "G-DPGSYE7LM8"
  };

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
    } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
    import {
      getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, onSnapshot, doc, getDoc, setDoc, updateDoc, where, getDocs
    } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';

    // 如果之后要启用图片上传再解开下面 3 行（当前未使用 Storage）
    // import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js';
    const STORAGE_ENABLED = false;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    // const storage = getStorage(app);

    /***** 2) UI 元素引用 *****/
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userName = document.getElementById('userName');
    const avatar = document.getElementById('avatar');

    const submitBtn = document.getElementById('submitBtn');
    const feed = document.getElementById('feed');
    const typeSel = document.getElementById('type');
    const notesEl = document.getElementById('notes');
    const locateBtn = document.getElementById('locateBtn');
    const snapBtn = document.getElementById('snapBtn');
    const mineOnly = document.getElementById('mineOnly');
    const exportCsvBtn = document.getElementById('exportCsv');
    const latlngEl = document.getElementById('latlng');
    const fileEl = document.getElementById('file');

    // Heatmap 相关
    const toggleHeatBtn = document.getElementById('toggleHeat');
    let heatOn = false;
    let heatLayer = null;

    /***** 3) 地图 *****/
    const map = L.map('map').setView([2.287, 111.83], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let marker = L.marker(map.getCenter(), { draggable: true }).addTo(map);
    function updateLatLngDisplay() {
      const { lat, lng } = marker.getLatLng();
      latlngEl.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }
    marker.on('dragend', updateLatLngDisplay);
    updateLatLngDisplay();

    snapBtn.addEventListener('click', () => {
      marker.setLatLng(map.getCenter());
      updateLatLngDisplay();
    });

    locateBtn.addEventListener('click', () => {
      if (!navigator.geolocation) return alert('Geolocation not supported');
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        map.setView([latitude, longitude], 16);
        marker.setLatLng([latitude, longitude]);
        updateLatLngDisplay();
      }, () => alert('Unable to get your location'));
    });

    /***** 4) 登录 / 登出 *****/
    signInBtn.addEventListener('click', async () => {
      try {
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      } catch (e) { console.error(e); alert('Sign-in failed.'); }
    });
    signOutBtn.addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, user => {
      const authed = !!user;
      document.body.classList.toggle('signed-in', authed);
      userName.textContent = authed ? (user.displayName || user.email) : 'Not signed in';
      avatar.src = authed && user.photoURL ? user.photoURL : 'https://i.pravatar.cc/40?img=12';
      refreshFeed(); // 登录状态变化时，刷新当前列表
      refreshHeat(); // 也刷新热力图
    });

    /***** 5) 提交报告（不含图片上传） *****/
    submitBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) return alert('Please sign in first.');

      const { lat, lng } = marker.getLatLng();
      const type = typeSel.value;
      const notes = (notesEl.value || '').trim();

      // 基本校验（和 Firestore 规则一致）
      const ALLOWED = ['Reckless driving', 'Illegal parking', 'Dangerous crossing', 'Other'];
      if (!ALLOWED.includes(type)) return alert('Invalid type.');
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) return alert('Invalid location.');
      if (notes.length > 400) return alert('Notes too long (<= 400).');

      try {
        await addDoc(collection(db, 'reports'), {
          type, lat, lng, notes,
          uid: user.uid,
          status: 'Pending',
          createdAt: serverTimestamp()
        });
        notesEl.value = '';
      } catch (e) {
        console.error(e);
        alert('Failed to submit. Check Firestore rules / network.');
      }
    });

    /***** 6) 列表 + CSV + Heatmap  *****/
    let unsubscribe = null;

    async function refreshFeed() {
      if (unsubscribe) { unsubscribe(); unsubscribe = null; }

      const baseQ = query(
        collection(db, 'reports'),
        orderBy('createdAt', 'desc'),
        limit(200)
      );

      unsubscribe = onSnapshot(baseQ, snapshot => {
        const mine = mineOnly.checked ? auth.currentUser?.uid : null;
        const docs = snapshot.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(d => !mine || d.uid === mine);

        renderFeed(docs);
        // 热力图数据也一并更新
        currentHeatData = docs.map(d => [d.lat, d.lng, 0.4]); // 第 3 个值是强度(0~1)
        if (heatOn) applyHeat();
      });
    }

    function statusBadge(s) {
      if (s === 'Resolved') return '<span class="status-badge status-resolved">Resolved</span>';
      if (s === 'In Progress') return '<span class="status-badge status-progress">In progress</span>';
      return '<span class="status-badge status-pending">Pending</span>';
    }

    function renderFeed(list) {
      feed.innerHTML = '';
      if (!list.length) {
        feed.innerHTML = '<div class="muted">No reports.</div>';
        return;
      }
      list.forEach(d => {
        const div = document.createElement('div');
        div.className = 'item';
        const when = d.createdAt?.toDate ? d.createdAt.toDate() : (d.createdAt || '—');
        div.innerHTML = `
          <div class="row1">
            <div class="title">${d.type}</div>
            <div>${statusBadge(d.status || 'Pending')}</div>
          </div>
          <div class="muted" style="margin:6px 0 8px">${d.lat?.toFixed?.(5)}, ${d.lng?.toFixed?.(5)} • ${when.toString().slice(0,24)}</div>
          ${d.notes ? `<div>${escapeHtml(d.notes)}</div>` : ''}
        `;
        feed.appendChild(div);
      });
    }

    exportCsvBtn.addEventListener('click', async () => {
      const qSnap = await getDocs(query(collection(db, 'reports'), orderBy('createdAt', 'desc'), limit(1000)));
      const rows = qSnap.docs.map(d => ({ id:d.id, ...d.data() }));
      const headers = ['id','type','lat','lng','notes','status','uid','createdAt'];
      const csv = [headers.join(',')].concat(
        rows.map(r => headers.map(h => {
          const v = r[h];
          if (h === 'createdAt') return r.createdAt?.toDate ? r.createdAt.toDate().toISOString() : '';
          return String(v ?? '').replace(/"/g,'""');
        }).map(x => `"${x}"`).join(','))
      ).join('\n');

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'reports.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // ---- Heatmap ----
    let currentHeatData = [];
    function applyHeat() {
      if (!heatLayer) heatLayer = L.heatLayer([], { radius: 22, blur: 18, maxZoom: 18 });
      heatLayer.setLatLngs(currentHeatData);
      if (!map.hasLayer(heatLayer)) heatLayer.addTo(map);
    }
    function clearHeat() {
      if (heatLayer && map.hasLayer(heatLayer)) map.removeLayer(heatLayer);
    }
    function refreshHeat() { if (heatOn) applyHeat(); }

    toggleHeatBtn.addEventListener('click', () => {
      heatOn = !heatOn;
      toggleHeatBtn.textContent = heatOn ? 'Heatmap (ON)' : 'Heatmap';
      if (heatOn) applyHeat(); else clearHeat();
    });

    // 工具
    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

    // 初始拉取
    refreshFeed();
  </script>
</head>
<body>
  <header>
    <div class="title">Sibu Smart Traffic <span class="badge">Beta+</span></div>
    <div class="spacer"></div>
    <div class="user"><img id="avatar" src="https://i.pravatar.cc/40?img=12" alt="" style="width:28px;height:28px;border-radius:50%;border:1px solid #2a3b69" />
      <span id="userName">Not signed in</span>
      <button id="signInBtn" class="btn">Sign in with Google</button>
      <button id="signOutBtn" class="btn">Sign out</button>
    </div>
  </header>

  <main>
    <!-- 左：提交 + 地图 -->
    <section class="card">
      <div class="head"><h3>Drop a report</h3></div>
      <div class="body">
        <div id="map"></div>

        <div style="margin-top:10px" class="toolbar">
          <button id="locateBtn" class="btn">Use my location</button>
          <button id="snapBtn" class="btn">Pin at map center</button>
          <span class="chip">Lat/Lng: <span id="latlng">—</span></span>
        </div>

        <div style="margin-top:12px" class="row">
          <div>
            <div class="muted" style="margin-bottom:6px;">Type</div>
            <select id="type" class="input">
              <option>Reckless driving</option>
              <option>Illegal parking</option>
              <option>Dangerous crossing</option>
              <option>Other</option>
            </select>
          </div>
          <div class="right">
            <div class="muted" style="margin-bottom:6px;">Actions</div>
            <div class="toolbar" style="justify-content:flex-end;">
              <label class="chip"><input id="mineOnly" type="checkbox" style="vertical-align:-2px;margin-right:6px;">Only my reports</label>
              <button id="toggleHeat" class="btn">Heatmap</button>
              <button id="exportCsv" class="btn-ghost btn">Export CSV</button>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="muted" style="margin-bottom:6px;">Notes (max 400 chars)</div>
          <textarea id="notes" rows="4" placeholder="Eg: Motorcycles weaving across lanes near Jalan Wong Nai Siong lights" class="input"></textarea>
        </div>

        <div style="margin-top:12px" class="row">
          <div>
            <div class="muted" style="margin-bottom:6px;">Photo (optional)</div>
            <input id="file" class="input" type="file" accept="image/*" />
            <div class="muted" style="margin-top:6px;">(当前免费计划未启用 Storage，图片会被忽略。)</div>
          </div>
          <div class="right" style="display:flex;align-items:flex-end;justify-content:flex-end;">
            <button id="submitBtn" class="btn-primary btn">Submit report</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 右：最新列表 -->
    <section class="card">
      <div class="head"><h3>Latest reports</h3></div>
      <div class="body">
        <div id="feed" class="list"></div>
      </div>
    </section>
  </main>

  <script>
    // 登录显示隐藏（非必要，仅优化 UI）
    (function(){
      const css = `
        body:not(.signed-in) #signOutBtn{display:none}
        body.signed-in #signInBtn{display:none}
      `;
      const s = document.createElement('style'); s.textContent = css; document.head.appendChild(s);
    })();
  </script>
</body>
</html>
