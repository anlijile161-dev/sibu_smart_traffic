<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sibu Smart Traffic — Beta</title>
  <meta name="theme-color" content="#0b1020"/>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    :root{--bg:#0b1020;--card:#141a2c;--muted:#8892a6;--accent:#5eead4;--text:#e6edf5;--danger:#ff7b7b}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#0b1020,#11162a);color:var(--text)}
    header{position:sticky;top:0;z-index:40;background:rgba(10,14,28,.7);backdrop-filter:blur(8px);border-bottom:1px solid #1f2942}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 18px}
    h1{font-size:clamp(20px,2.4vw,28px);margin:0;font-weight:700;letter-spacing:.3px}
    .tag{display:inline-block;font-size:12px;color:#0b1020;background:var(--accent);padding:3px 8px;border-radius:999px;margin-left:10px;font-weight:700}
    .row{display:grid;grid-template-columns:1.1fr .9fr;gap:18px;margin:18px 0}
    @media (max-width:900px){.row{grid-template-columns:1fr;}}
    .card{background:var(--card);border:1px solid #1f2942;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{margin:0 0 8px;font-size:18px}
    .card .body{padding:16px}
    .muted{color:var(--muted)}
    button,.btn{background:#26304f;color:#fff;border:1px solid #2f3a5d;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    button:hover{filter:brightness(1.1)}
    .btn-danger{background:#3a1f26;border-color:#652b35}
    .btn-accent{background:#0e2f2b;border-color:#2a5f57;color:#ccfff7}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#1a2136;border:1px solid #273154}
    #map{height:380px;border-radius:14px;border:1px solid #1f2942}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid-1{display:grid;grid-template-columns:1fr;gap:10px}
    label{font-size:13px;color:#9aa6bf}
    input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid #26304f;background:#0d1222;color:#e6edf5}
    textarea{min-height:90px;resize:vertical}
    .feed{display:grid;gap:10px;max-height:460px;overflow:auto;padding:8px}
    .item{display:grid;grid-template-columns:24px 1fr;gap:10px;padding:10px;border-radius:12px;background:#0e1326;border:1px solid #222d4a}
    .dot{width:10px;height:10px;border-radius:50%}
    .type{font-weight:700}
    .small{font-size:12px;color:#9aa6bf}
    .footer{margin-top:6px}
    .signin{display:flex;gap:10px;align-items:center}
    .avatar{width:28px;height:28px;border-radius:50%;border:1px solid #2b3556}
    .points{font-weight:700;color:var(--accent)}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div>
        <h1>Sibu Smart Traffic <span class="tag">Beta</span></h1>
        <div class="muted" style="font-size:13px">Report unsafe behavior • See hotspots • Earn points for safe roads</div>
      </div>
      <div class="signin">
        <img id="avatar" class="avatar" alt=""/>
        <div id="userName" class="small muted">Not signed in</div>
        <button id="signInBtn" class="btn-accent">Sign in with Google</button>
        <button id="signOutBtn" class="btn btn-danger" style="display:none">Sign out</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="row">
      <section class="card">
        <div class="body">
          <h2>Drop a report</h2>
          <p class="muted" style="margin-top:0">Drag the pin or use "Use my location". Only signed-in users can submit.</p>
          <div id="map"></div>
          <div style="height:8px"></div>
          <div class="grid">
            <div>
              <label>Type</label>
              <select id="type">
                <option>Reckless driving</option>
                <option>Illegal parking</option>
                <option>Dangerous crossing</option>
                <option>Speeding</option>
                <option>Road hazard</option>
                <option>Other</option>
              </select>
            </div>
            <div>
              <label>Quick actions</label>
              <div class="grid-1">
                <button id="locateBtn">Use my location</button>
                <button id="snapBtn" title="Places a pin at map center">Pin at map center</button>
              </div>
            </div>
          </div>
          <div style="height:10px"></div>
          <label>Notes (max 400 chars)</label>
          <textarea id="notes" placeholder="Eg: Motorcycles weaving across lanes near Jalan Wong Nai Siong lights"></textarea>
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:10px">
            <div class="pill small">Lat/Lng: <span id="latlng">—</span></div>
            <button id="submitBtn" class="btn-accent">Submit report</button>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="body">
          <h2>Latest reports <span id="count" class="small muted"></span></h2>
          <div class="feed" id="feed"></div>
          <div class="footer small">Signed-in points: <span class="points" id="points">0</span></div>
        </div>
      </section>
    </div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <script type="module">
    // Firebase config for your project (Web app credentials)
    const firebaseConfig = {
      apiKey: "AIzaSyCHLxlEzLGC1gN1v0ryQe29acqb6IjM-YQ",
      authDomain: "sibu-smart-traffic.firebaseapp.com",
      projectId: "sibu-smart-traffic",
      storageBucket: "sibu-smart-traffic.firebasestorage.app",
      messagingSenderId: "426450565021",
      appId: "1:426450565021:web:6dc1dc2542d0046c11a174",
      measurementId: "G-DPGSYE7LM8"
    };

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, onSnapshot, doc, getDoc, setDoc, increment, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userName = document.getElementById('userName');
    const avatar = document.getElementById('avatar');
    const submitBtn = document.getElementById('submitBtn');
    const feed = document.getElementById('feed');
    const typeSel = document.getElementById('type');
    const notesEl = document.getElementById('notes');
    const latlngEl = document.getElementById('latlng');
    const countEl = document.getElementById('count');
    const pointsEl = document.getElementById('points');

    // Map
    const map = L.map('map').setView([2.287, 111.83], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'}).addTo(map);
    let marker = L.marker(map.getCenter(), {draggable: true}).addTo(map);
    function updateLatLngDisplay(){const {lat,lng}=marker.getLatLng(); latlngEl.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;}
    marker.on('dragend', updateLatLngDisplay); updateLatLngDisplay();
    document.getElementById('snapBtn').addEventListener('click', ()=>{marker.setLatLng(map.getCenter()); updateLatLngDisplay();});
    document.getElementById('locateBtn').addEventListener('click', ()=>{
      if(!navigator.geolocation) return alert('Geolocation not supported');
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude,longitude}=pos.coords; map.setView([latitude,longitude],16); marker.setLatLng([latitude,longitude]); updateLatLngDisplay();
      },()=>alert('Unable to get your location'));
    });

    // Auth
    const provider = new GoogleAuthProvider();
    signInBtn.addEventListener('click', async ()=>{ try{ await signInWithPopup(auth, provider); }catch(e){ alert(e.message);} });
    signOutBtn.addEventListener('click', async ()=>{ await signOut(auth); });

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        userName.textContent = user.displayName || user.email;
        avatar.src = user.photoURL || '';
        signInBtn.style.display='none'; signOutBtn.style.display='inline-block';
        const uref = doc(db, 'users', user.uid);
        const snap = await getDoc(uref);
        if(!snap.exists()){ await setDoc(uref, { displayName: user.displayName||'', points: 0, createdAt: serverTimestamp() }); }
        const current = await getDoc(uref);
        pointsEl.textContent = (current.data()?.points ?? 0).toString();
      }else{
        userName.textContent = 'Not signed in';
        avatar.removeAttribute('src');
        signInBtn.style.display='inline-block'; signOutBtn.style.display='none';
        pointsEl.textContent='0';
      }
    });

    // Submit report
    submitBtn.addEventListener('click', async ()=>{
      const user = auth.currentUser;
      if(!user) return alert('Please sign in first.');
      const type = typeSel.value;
      const notes = (notesEl.value||'').trim();
      if(notes.length>400) return alert('Notes too long');
      const {lat,lng}=marker.getLatLng();
      try{
        await addDoc(collection(db,'reports'), {
          uid:user.uid, author:user.displayName||user.email||'Anonymous', type, notes, lat, lng, createdAt: serverTimestamp()
        });
        const uref = doc(db,'users',user.uid);
        await updateDoc(uref,{points: increment(5)}).catch(async()=>{ await setDoc(uref,{points:5},{merge:true}); });
        const snap = await getDoc(uref); pointsEl.textContent = (snap.data()?.points ?? 0).toString();
        notesEl.value=''; alert('Report submitted. Thank you!');
      }catch(e){ alert(e.message); }
    });

    // Live feed
    const q = query(collection(db,'reports'), orderBy('createdAt','desc'), limit(20));
    onSnapshot(q, (snapshot)=>{
      countEl.textContent = `(${snapshot.size})`;
      feed.innerHTML='';
      snapshot.forEach(docu=>{
        const d=docu.data();
        const div=document.createElement('div'); div.className='item';
        const dot=document.createElement('div'); dot.className='dot';
        dot.style.background = d.type==='Illegal parking'?'#f59e0b': d.type==='Reckless driving'?'#ef4444':'#22d3ee';
        const main=document.createElement('div');
        const when = d.createdAt?.toDate ? d.createdAt.toDate() : new Date();
        main.innerHTML = `<div class="type">${d.type}</div>
          <div class="small">${(d.notes||'').replace(/</g,'&lt;')}</div>
          <div class="small">By ${d.author||'User'} • ${when.toLocaleString()} • (${d.lat?.toFixed?.(4)}, ${d.lng?.toFixed?.(4)})</div>`;
        div.appendChild(dot); div.appendChild(main); feed.appendChild(div);
      });
    });

    // Register service worker (optional)
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }
  </script>
</body>
</html>
